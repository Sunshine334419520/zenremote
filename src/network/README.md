# ç½‘ç»œå±‚ç›®å½•ç»“æ„

æœ¬ç›®å½•æŒ‰ç…§åˆ†å±‚æ¶æ„ç»„ç»‡ï¼Œæ¸…æ™°åœ°åˆ†ç¦»å„å±‚èŒè´£ã€‚

## ç›®å½•ç»“æ„

```
src/network/
â”œâ”€â”€ io/                          # ç½‘ç»œ I/O å±‚ (Layer 1)
â”‚   â”œâ”€â”€ udp_socket.h            # UDP Socket å°è£…
â”‚   â””â”€â”€ udp_socket.cpp
â”‚
â”œâ”€â”€ transport/                   # ä¼ è¾“å±‚ (Layer 2)
â”‚   â”œâ”€â”€ base_connection.h       # è¿æ¥æŠ½è±¡æ¥å£
â”‚   â”œâ”€â”€ direct_connection.h     # ç›´è¿å®ç° (Phase 1)
â”‚   â”œâ”€â”€ direct_connection.cpp
â”‚   â””â”€â”€ turn_connection.h       # TURN ä¸­ç»§å®ç° (Phase 2, å¾…å®ç°)
â”‚
â”œâ”€â”€ connection_manager/          # è¿æ¥ç®¡ç†å±‚ (Layer 3)
â”‚   â”œâ”€â”€ connection_manager.h    # ç»Ÿä¸€çš„è¿æ¥ç®¡ç†æ¥å£
â”‚   â””â”€â”€ connection_manager.cpp
â”‚
â””â”€â”€ protocol/                    # åè®®å±‚ (Layer 4)
    â”œâ”€â”€ packet.h                # RTP åŒ…å®šä¹‰
    â”œâ”€â”€ protocol.h              # æ§åˆ¶æ¶ˆæ¯å®šä¹‰
    â”œâ”€â”€ rtp_sender.h            # RTP å‘é€å™¨
    â”œâ”€â”€ rtp_sender.cpp
    â”œâ”€â”€ rtp_receiver.h          # RTP æ¥æ”¶å™¨
    â”œâ”€â”€ rtp_receiver.cpp
    â”œâ”€â”€ handshake.h             # æ¡æ‰‹åè®®
    â”œâ”€â”€ handshake.cpp
    â”œâ”€â”€ pacer.h                 # æµé‡è°ƒåº¦
    â”œâ”€â”€ pacer.cpp
    â”œâ”€â”€ jitter_buffer.h         # æŠ–åŠ¨ç¼“å†²
    â”œâ”€â”€ jitter_buffer.cpp
    â”œâ”€â”€ reliable_input.h        # å¯é è¾“å…¥ä¼ è¾“
    â””â”€â”€ reliable_input.cpp
```

## åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨å±‚ (Application Layer)                        â”‚
â”‚  - ControllerSession / ControlledSession          â”‚
â”‚  â†“ åªä¾èµ– ConnectionManager                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿æ¥ç®¡ç†å±‚ (Connection Manager) - Layer 3        â”‚
â”‚  - ConnectionManager (ç»Ÿä¸€æ¥å£)                   â”‚
â”‚  - è‡ªåŠ¨é€‰æ‹©è¿æ¥æ–¹å¼ (Direct/TURN)                 â”‚
â”‚  â†“ å†…éƒ¨ä½¿ç”¨ BaseConnection                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¼ è¾“å±‚ (Transport Layer) - Layer 2               â”‚
â”‚  - BaseConnection (æŠ½è±¡æ¥å£)                      â”‚
â”‚  - DirectConnection (Phase 1)                     â”‚
â”‚  - TurnConnection (Phase 2)                       â”‚
â”‚  â†“ ä½¿ç”¨ UdpSocket è¿›è¡Œå®é™… I/O                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç½‘ç»œ I/O å±‚ (Network I/O Layer) - Layer 1        â”‚
â”‚  - UdpSocket (çº¯ UDP Socket å°è£…)                 â”‚
â”‚  - è·¨å¹³å°æ”¯æŒ (Windows/Linux/macOS)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å„å±‚èŒè´£

### Layer 1: ç½‘ç»œ I/O å±‚ (`io/`)

**èŒè´£**ï¼š
- æä¾›çº¯ç²¹çš„ UDP Socket æ“ä½œæ¥å£
- å¤„ç†è·¨å¹³å°å·®å¼‚ (Winsock2 vs BSD sockets)
- é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- ç»Ÿè®¡ä¿¡æ¯æ”¶é›†

**ä¸è´Ÿè´£**ï¼š
- ä¸çŸ¥é“è¿œç¨‹ç«¯ç‚¹æ˜¯è°
- ä¸çŸ¥é“è¿æ¥çŠ¶æ€
- ä¸å¤„ç†åè®®é€»è¾‘

**æ ¸å¿ƒç±»**ï¼š
- `UdpSocket`: UDP Socket å°è£…

### Layer 2: ä¼ è¾“å±‚ (`transport/`)

**èŒè´£**ï¼š
- å®šä¹‰è¿æ¥æŠ½è±¡æ¥å£ (`BaseConnection`)
- å®ç°ä¸åŒçš„è¿æ¥æ–¹å¼ (Direct / TURN)
- ç®¡ç†è¿œç¨‹ç«¯ç‚¹ä¿¡æ¯
- æä¾›ç»Ÿä¸€çš„ Send/Recv æ¥å£

**ä¸è´Ÿè´£**ï¼š
- ä¸ç›´æ¥æ“ä½œ socket (å§”æ‰˜ç»™ UdpSocket)
- ä¸å¤„ç† RTP åè®®ç»†èŠ‚
- ä¸åšè¿æ¥é€‰æ‹©å†³ç­– (ç”± ConnectionManager è´Ÿè´£)

**æ ¸å¿ƒç±»**ï¼š
- `BaseConnection`: è¿æ¥æŠ½è±¡æ¥å£
- `DirectConnection`: å±€åŸŸç½‘ç›´è¿å®ç°
- `TurnConnection`: TURN ä¸­ç»§å®ç° (Phase 2)

### Layer 3: è¿æ¥ç®¡ç†å±‚ (`connection_manager/`)

**èŒè´£**ï¼š
- åº”ç”¨å±‚å”¯ä¸€ä¾èµ–çš„è¿æ¥æ¥å£
- è‡ªåŠ¨é€‰æ‹©æœ€ä½³è¿æ¥æ–¹å¼
- ç®¡ç†è¿æ¥ç”Ÿå‘½å‘¨æœŸ
- æä¾›ç»Ÿä¸€çš„ Send/Recv æ¥å£ç»™åº”ç”¨å±‚

**ä¼˜åŠ¿**ï¼š
- åº”ç”¨å±‚æ— éœ€å…³å¿ƒåº•å±‚ä½¿ç”¨ Direct è¿˜æ˜¯ TURN
- Phase 2 æ‰©å±•å¯¹åº”ç”¨å±‚é€æ˜
- å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢è¿æ¥æ–¹å¼

**æ ¸å¿ƒç±»**ï¼š
- `ConnectionManager`: ç»Ÿä¸€çš„è¿æ¥ç®¡ç†å™¨

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```cpp
// åº”ç”¨å±‚ä»£ç  - æ°¸è¿œåªä¾èµ– ConnectionManager
ConnectionManager conn_mgr;

// Phase 1: ç›´è¿é…ç½®
ConnectionManager::Config config;
config.mode = ConnectionManager::Mode::kDirect;
config.remote_ip = "192.168.1.100";
config.remote_port = 50000;

conn_mgr.Initialize(config);
conn_mgr.Connect();

// å‘é€/æ¥æ”¶æ•°æ® (æ— éœ€å…³å¿ƒåº•å±‚æ˜¯ Direct è¿˜æ˜¯ TURN)
conn_mgr.Send(data, length);
conn_mgr.Recv(buffer, size, timeout);
```

### Layer 4: åè®®å±‚ (`protocol/`)

**èŒè´£**ï¼š
- å®šä¹‰ RTP åŒ…æ ¼å¼å’Œåºåˆ—åŒ–
- å®ç° RTP å‘é€å™¨å’Œæ¥æ”¶å™¨
- å®ç°æ¡æ‰‹åè®®
- å®ç°æµé‡è°ƒåº¦ (Pacer)
- å®ç°æŠ–åŠ¨ç¼“å†² (JitterBuffer)
- å®ç°å¯é è¾“å…¥ä¼ è¾“

**æ ¸å¿ƒç±»**ï¼š
- `RTPSender`: RTP åŒ…å‘é€å™¨
- `RTPReceiver`: RTP åŒ…æ¥æ”¶å™¨
- `HandshakeManager`: æ¡æ‰‹åè®®ç®¡ç†
- `Pacer`: æµé‡è°ƒåº¦å™¨
- `JitterBuffer`: æŠ–åŠ¨ç¼“å†²å™¨
- `ReliableInputSender/Receiver`: å¯é è¾“å…¥ä¼ è¾“

## ä¾èµ–å…³ç³»

```
åº”ç”¨å±‚
  â†“ ä¾èµ–
ConnectionManager (Layer 3)
  â†“ ä¾èµ–
BaseConnection (Layer 2)
  â†“ ä¾èµ–
UdpSocket (Layer 1)

åè®®å±‚ (Layer 4)
  â†“ ä¾èµ–
BaseConnection (Layer 2) â† ç”¨äºå‘é€ RTP åŒ…
```

**å…³é”®è®¾è®¡åŸåˆ™**ï¼š
- ä¸Šå±‚å¯ä»¥ä¾èµ–ä¸‹å±‚ï¼Œä¸‹å±‚ä¸èƒ½ä¾èµ–ä¸Šå±‚
- åº”ç”¨å±‚åªä¾èµ– `ConnectionManager`
- `ConnectionManager` å†…éƒ¨å†³å®šä½¿ç”¨å“ªä¸ª `BaseConnection` å®ç°
- åè®®å±‚é€šè¿‡ `BaseConnection` æ¥å£å‘é€æ•°æ®ï¼Œä¸å…³å¿ƒåº•å±‚å®ç°

## Phase 1 vs Phase 2

### Phase 1 (å½“å‰å®ç°)
- âœ… Layer 1: `UdpSocket` (å®Œæ•´å®ç°)
- âœ… Layer 2: `DirectConnection` (å®Œæ•´å®ç°)
- âœ… Layer 3: `ConnectionManager` (ä»…æ”¯æŒ Direct æ¨¡å¼)
- âœ… Layer 4: æ‰€æœ‰åè®®å±‚ç»„ä»¶ (å®Œæ•´å®ç°)

### Phase 2 (å¾…æ‰©å±•)
- âœ… Layer 1: æ— éœ€ä¿®æ”¹ (å·²å®Œæ•´)
- ğŸš§ Layer 2: æ·»åŠ  `TurnConnection` å®ç°
- ğŸš§ Layer 3: æ‰©å±• `ConnectionManager` æ”¯æŒ TURN å’Œ Auto æ¨¡å¼
- âœ… Layer 4: æ— éœ€ä¿®æ”¹ (å·²å®Œæ•´)

**æ‰©å±•æ€§éªŒè¯**ï¼š
- âœ… åº”ç”¨å±‚ä»£ç æ— éœ€ä¿®æ”¹
- âœ… åªéœ€åœ¨ Layer 2 æ·»åŠ  `TurnConnection`
- âœ… åªéœ€åœ¨ Layer 3 å®ç° `CreateTurnConnection()` å’Œ `CreateAutoConnection()`
- âœ… æ‰€æœ‰å…¶ä»–å±‚ä¿æŒä¸å˜

## æµ‹è¯•ç­–ç•¥

### Layer 1 æµ‹è¯•
```cpp
TEST(UdpSocket, SendRecv) {
  // ç‹¬ç«‹æµ‹è¯• UDP Socket åŸºæœ¬åŠŸèƒ½
}
```

### Layer 2 æµ‹è¯•
```cpp
TEST(DirectConnection, Initialize) {
  // æµ‹è¯•ç›´è¿åˆå§‹åŒ–å’Œæ•°æ®ä¼ è¾“
}
```

### Layer 3 æµ‹è¯•
```cpp
TEST(ConnectionManager, DirectMode) {
  // æµ‹è¯•è¿æ¥ç®¡ç†å™¨çš„ç›´è¿æ¨¡å¼
}
```

### Layer 4 æµ‹è¯•
```cpp
TEST(RTPSender, SendVideoFrame) {
  // æµ‹è¯• RTP å‘é€å™¨
}
```

## æ³¨æ„äº‹é¡¹

1. **include è·¯å¾„è§„èŒƒ**ï¼š
   - æ‰€æœ‰ include ä½¿ç”¨å®Œæ•´è·¯å¾„ï¼š`#include "network/xxx/yyy.h"`
   - é¿å…ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼š`#include "yyy.h"` âŒ

2. **å‘½åç©ºé—´**ï¼š
   - ç»Ÿä¸€ä½¿ç”¨ `namespace zenremote`

3. **æ—¥å¿—æ¨¡å—**ï¼š
   - æ‰€æœ‰ç½‘ç»œå±‚ä»£ç ä½¿ç”¨ `LOG_MODULE_NETWORK`

4. **é”™è¯¯å¤„ç†**ï¼š
   - ç»Ÿä¸€ä½¿ç”¨ `Result<T>` æ¨¡å¼
   - é”™è¯¯ä¿¡æ¯åŒ…å«ä¸Šä¸‹æ–‡

5. **å‰å‘å£°æ˜**ï¼š
   - å¤´æ–‡ä»¶å°½é‡ä½¿ç”¨å‰å‘å£°æ˜å‡å°‘ä¾èµ–
   - å®ç°æ–‡ä»¶æ‰ include å®Œæ•´å¤´æ–‡ä»¶

## æ€»ç»“

è¿™ä¸ªç›®å½•ç»“æ„æ¸…æ™°åœ°ä½“ç°äº†åˆ†å±‚æ¶æ„ï¼š

1. **èŒè´£æ¸…æ™°**ï¼šæ¯å±‚åªåšè‡ªå·±çš„äº‹
2. **ä»£ç å¤ç”¨**ï¼šæ‰€æœ‰ä¼ è¾“å±‚å…±äº«åŒä¸€å¥— Socket ä»£ç 
3. **æ˜“äºæ‰©å±•**ï¼šPhase 2 æ‰©å±•æ— éœ€ä¿®æ”¹ Phase 1
4. **åº”ç”¨é€æ˜**ï¼šåº”ç”¨å±‚åªä¾èµ– ConnectionManagerï¼Œåº•å±‚åˆ‡æ¢å¯¹åº”ç”¨é€æ˜
5. **æ˜“äºæµ‹è¯•**ï¼šæ¯å±‚å¯ä»¥ç‹¬ç«‹æµ‹è¯•

è¿™å°±æ˜¯æ­£ç¡®çš„åˆ†å±‚æ¶æ„è®¾è®¡ï¼ğŸ¯
